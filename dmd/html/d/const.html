
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<!--
	Copyright (c) 1999-2008 by Digital Mars
	All Rights Reserved
	Written by Walter Bright
	www.digitalmars.com
  -->

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="keywords" content="D Programming Language, const, final, invariant, mutable,
logical constness, C++" />
<meta name="description" content="Why const was redesigned in D.

" />
<title>Here a Const, There a Const - D Programming Language 2.0 - Digital Mars</title>
<link rel="stylesheet" type="text/css" href="style.css" />
<link rel="stylesheet" type="text/css" href="print.css" media="print" />
<link rel="shortcut icon" href="favicon.ico" />
</head>

<body>
<div id="heading">
	<a href="http://www.digitalmars.com/"><img src="dmlogo.gif" width="270" height="53" style="border-style:none" alt="www.digitalmars.com" align="left"></a>
	<p align="right">D Programming Language 2.0</p>
	<br>

	<div id="headingNav">
	<ul>	<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?DocComments/Const" title="Read/write comments and feedback">Comments</a></li>
	<li><a href="index.html" title="D Programming Language" class="dlink">D</a></li>
	<li><a href="http://www.digitalmars.com/advancedsearch.html" title="Search Digital Mars web site">Search</a></li>
	<li><a href="http://www.digitalmars.com/d/download.html" title="download D">Downloads</a></li>
	<li><a href="http://www.digitalmars.com/" title="www.digitalmars.com">Home</a></li>
	</ul>
	</div>

	<div id="lastupdate">Last update Thu Mar  6 15:44:03 2008
</div>
</div>

<!-- Generated by Ddoc from const.d -->



<div id="navigation">
  
<div class="navblock">
<form method="get" action="http://www.google.com/search">
<div id="searchbox">
<input id="q" name="q" size="10" value="Search" onFocus='if(this.value == "Search"){this.value="";}'>
<input type="hidden" id="domains" name="domains" value="www.digitalmars.com">
<input type="hidden" id="sitesearch" name="sitesearch" value="www.digitalmars.com/d/2.0">
<input type="hidden" id="sourceid" name="sourceid" value="google-search">
<input type="submit" id="submit" name="submit" value="Go">
</div>
</form>
<div id="toctop">
    <ul>	<li><a href="index.html" title="D Programming Language">D &rarr;</a></li>
	<li><a href="lex.html" title="D Language Specification">Language &rarr;</a></li>
	<li><a href="phobos/phobos.html" title="D Runtime Library">Phobos &rarr;</a></li>
	<li><a href="comparison.html" title="Language Comparisons">Comparisons &rarr;</a></li>
	<li><a href="http://www.digitalmars.com/d/1.0/index.html" title="D Programming Language 1.0">D 1.0 &rarr;</a></li>
    </ul>
</div>
</div>

  
    <div class="navblock">
	<ul>		<li><a href="overview.html" title="D language overview">Overview</a></li>

		<li><a href="windows.html" title="D implementation for 32 bit Windows systems">D for Win32</a></li>

		<li><a href="dll.html" title="Writing 32 bit Windows DLLs in D">Win32 DLLs in D</a></li>

		<li><a href="COM.html" title="Windows COM Programming">COM Programming</a></li>

		<li><a href="htomodule.html" title="converting C .h header files to D modules">C .h to D Modules</a></li>

		<li><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>

		<li><a href="dstyle.html" title="Recommended programming style conventions">Style Guide</a></li>

		<li><a href="wc.html" title="wc - the wordcount program">Example: wc</a></li>

		<li><a href="future.html" title="Future directions">Future</a></li>

		<li><a href="changelog.html" title="History of changes to D">D Change Log</a></li>

		<li><a href="features2.html" title="Language changes for D 2.0">2.0 Features</a></li>

		<li><a href="http://www.digitalmars.com/techtips/index.html" title="Programming tips">Tech Tips</a></li>

		<li><a href="rationale.html" title="Answers to questions about D design decisions">Rationale</a></li>

		<li><a href="warnings.html" title="Explanation of D compiler generated warning messages">Warnings</a></li>

		<li><a href="http://d.puremagic.com/issues/" title="D issue and bug tracking system">Issues &amp; Bugs</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Articles</h2>
	<ul>		<li><a href="hijack.html" title="Function Hijacking Mitigation">Hijacking</a></li>

		<li><a href="const.html" title="Here a Const There a Const">Const</a></li>

		<li><a href="memory.html" title="Memory management techniques in D">Memory Management</a></li>

		<li><a href="exception-safe.html" title="Exception safe programming techniques">Exception Safety</a></li>

		<li><a href="templates-revisited.html" title="D takes a fresh look at template design">Templates Revisited</a></li>

		<li><a href="regular-expression.html" title="Programming with regular expressions">Regular Expressions</a></li>

		<li><a href="lazy-evaluation.html" title="Lazy evaluation of function arguments">Lazy Evaluation</a></li>

		<li><a href="variadic-function-templates.html" title="Variadic arguments to templates">Variadic Templates</a></li>

		<li><a href="tuple.html" title="What tuples are and how to use them">Tuples</a></li>

		<li><a href="mixin.html" title="String mixins compile string literals into D programs">Mixins</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Tools</h2>
	<ul>		<li><a href="dcompiler.html" title="dmd - the Digital Mars D compiler">DMD D Compiler</a></li>

		<li><a href="http://dgcc.sourceforge.net/" title="gdc - the Gnu D compiler">GDC D Compiler</a></li>

		<li><a href="http://www.digitalmars.com/ctg/optlink.html" title="Optlink - the Digital Mars Linker">Linker</a></li>

		<li><a href="http://www.digitalmars.com/ctg/trace.html" title="DMD's builtin code profiling tool">Profiler</a></li>

		<li><a href="code_coverage.html" title="DMD's builtin code coverage analysis tool">Code Coverage</a></li>

		<li><a href="rdmd.html" title="rdmd - run D programs as if they were scripts">DMD Script Shell</a></li>

		<li><a href="windbg.html" title="windbg - debugging Windows programs">Windows Debugger</a></li>

		<li><a href="htod.html" title="htod - mechanically convert C .h header files to D">C .h to D .d</a></li>

		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?EditorSupport" title="Editors with support for D">Editors</a></li>

		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?ReferenceForTools" title="Even more tools for D">More Tools</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Community</h2>
	<ul>		<li><a href="http://d.puremagic.com/conference2007/" title="D Programming Language Conference">D Conference</a></li>

		
		<li><a href="http://www.digitalmars.com/NewsGroup.html" title="How to connect to D newsgroups">News</a></li>

		<li><a href="http://www.digitalmars.com/webnews/newsgroups.php?search_txt=&group=digitalmars.D
" title="Forum for general D topics">D forum</a></li>

		<li><a href="http://www.digitalmars.com/webnews/newsgroups.php?search_txt=&group=digitalmars.D.announce
" title="Forum for D announcements">Announcements</a></li>

		<li><a href="http://www.digitalmars.com/webnews/newsgroups.php?search_txt=&group=digitalmars.D.learn
" title="Forum for learning D">Learn</a></li>

		<li><a href="http://www.digitalmars.com/webnews/newsgroups.php?search_txt=&group=digitalmars.D.debugger
" title="Forum for D debuggers">Debugging</a></li>

		<li><a href="http://www.digitalmars.com/d/dlinks.html" title="External D related links">D links</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Archives</h2>
	<ul>		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/index.html">digitalmars.D</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/dtl/index.html">digitalmars.D.dtl</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/announce/index.html">digitalmars.D.announce</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/dwt/index.html">digitalmars.D.dwt</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/learn/index.html">digitalmars.D.learn</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/bugs/index.html">digitalmars.D.bugs</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/debugger/index.html">digitalmars.D.debugger</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/D/gnu/index.html">D.gnu</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/index.html">Old D</a></li>
	</ul>
    </div>

    <div class="navblock">
	<h2>Appendices</h2>
	<ul>		<li><a href="glossary.html" title="D acronyms and jargon explained">Glossary</a></li>

		<li><a href="ascii-table.html" title="Handy ascii chart">Ascii Table</a></li>

		<li><a href="acknowledgements.html" title="Thank-you to these people who have helped with D">Acknowledgements</a></li>

	</ul>
    </div>

    
<form action="http://www.google.com/translate" onsubmit="this.u.value=window.location.href" method="GET">
<input value="en" name="hl" type="hidden"/>
<input value="UTF8" name="ie" type="hidden"/>
<input value="" name="u" type="hidden"/>
<select name="langpair">
<option value="en|de"/>German
<option value="en|fr"/>French
<option value="en|it"/>Italian
<option value="en|pt"/>Portuguese
<option value="en|es"/>Spanish
<option value="en|ar"/>Arabic
<option value="en|zh-CN"/>Chinese (Simplified)
<option value="en|ja"/>Japanese
<option value="en|ko"/>Korean
<option value="en|ru"/>Russian
</select><br/>
<input value="Translate" type="submit"/>
</form>


    
<br><br>
<br><br>
<script type="text/javascript"><!--
/**/google_ad_client = "pub-5628673096434613";
/* 180x150, created 2/18/08 */
/**/google_ad_slot = "4228873179";
/**/google_ad_width = 180;
/**/google_ad_height = 150;
/**/google_cpa_choice = ""; // on file
//-->
</script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>



</div>
<div id="content">
  <h1>        Here A Const, There A Const</h1>
  
<p><i>by Walter Bright</i></p>


<p>In a small, experimental program, it's great to benefit from a programming
system that's flexible, permissive, and not too pedantic.
As the complexity of a program increases, it gets more beneficial
to specify the semantics of a declaration in the code itself.
Programmers want to carve subdomains in the large application and confine
specific state changes to small sections of code. Doing so rids them of
long-distance coupling among portions of code that modify the same data.
Documentation is unreliable as it is inevitably wrong, misleading,
incomplete, out of date, or just plain missing.
Of significant utility in this is the notion of constness.
C and C++ have added the ability to specify the constness of variables
and functions, and it has clearly demonstrated over time that it is
popular and useful, and many consider it crucial for developing
large programs.
In an attempt to simplify, Java dropped const. Its handling of
immutable strings and the often-used technique of preemptive copy-out are
awkward at best. As a consequence, putting const back into the language has
become a favorite indoor sport for industry and academia alike.
But C++'s const has a number of important shortcomings, so D took the
opportunity to reengineer the concept from top to bottom.
This article explores what constness is good for, how C++ constness
addresses it, and how D addresses it.
</p>


<h2>What Do We Want From Const?</h2>

<p>There are a number of benefits that can be derived from knowing something
is constant, including benefits to optimization and code generation:
</p>

<ol><li>Constant data need never be copied! It can be infinitely shared (e.g.
	via pointers and references) as there is never contention on it. This
	leads to programs that are both correct and efficient.
</li>

<li>The most obvious is to just be able to name a manifest constant
	or string.
</li>

<li>Constant data can be placed into ROM (read only memory).
</li>

<li>Const parameters indicate that a function will not modify whatever
	its arguments refer to, with a direct positive effect on modularity.
</li>

<li>Constant data indicates that other threads or other aliases to the data
	cannot modify it.
</li>

<li>A constant can be propagated and folded, which pulls operations
	from run time into compile time.
</li>

<li>Data flow analysis is aided when there's a guarantee that constant
	data will not change as a side effect of other operations.
</li>

<li>Constant data can be cached or mirrored in registers without
	needing to synchronize them with memory.
</li>

<li>Const reduces the cognitive load on the programmer - by looking at
	constness in the declaration, he can learn things about whatever
	uses that declaration without having to slog through that code.
</li>
</ol>


<h2>How Does C++ Const Stack Up?</h2>


<p>C++ const comes in two forms: const as a storage class, and const
as a type attribute.
</p>

<p>Const as a storage class is most useful for
declaring manifest constants, such as:
</p>

<pre class="cppcode">const int X = 3;
</pre>

<p>and the language guarantees that <tt>X</tt> will never be anything but 3.
<tt>X</tt> can be put into ROM, and the optimizer can reliably replace all
rvalues of <tt>X</tt> with 3. Const is a storage class when it applies to the
top level type of the declaration. <a href="#note1">[1]</a>
</p>

<p>Const as a type attribute is different. It becomes a type attribute
when it does not apply to the top level type of a declaration:
</p>

<pre class="cppcode">int x = 3;
const int *p = &x;
</pre>

<p>Here the const applies to the int that <tt>p</tt> is pointing to, not <tt>p</tt>.
Const as a type attribute means that a read only view of data is taken.
It doesn't mean that the data is constant. For example:
</p>

<pre class="cppcode">int x = 3;
const int *p = &x;
*p = 4;		// error, read-only view

const int *q = &x;
int z = *q;	// z is set to 3
x = 5;		// ok
int y = *q;	// y is set to 5
</pre>

<p><tt>z</tt> is not equal to <tt>y</tt>, even though <tt>*q</tt> is const.
This is one instance of the so-called aliasing problem,
since while the above
snippet is trivial, the existence of such aliases can be very hard
to detect in a complex program. It is impossible for the compiler to
reliably detect it. This means that the compiler cannot cache 3 in
a register and reuse the cached value to replace <tt>*q</tt>, it must
go back and actually dereference <tt>q</tt> again.
</p>

<p>Consider a function defined as:
</p>

<pre class="cppcode">void foo(const int *p);
</pre>

<p>Ostensibly, it looks like I can safely pass references to my int variables to
<tt>foo()</tt> and be assured that <tt>foo()</tt> won't be changing my ints.
But that isn't true:
</p>

<pre class="cppcode">void foo(const int *p)
{
    int *q = const_cast&lt;int *&gt;(p);
    *q = 4;
}
</pre>

<p><tt>foo()</tt> has not only cast away the constness, but it has gone and modified
my precious int variable, even though <tt>foo()</tt>'s interface promised it
would not.
Even worse, this is legal and well-defined C++, and must be supported by
any C++ compiler. While writing such code is frowned upon by professional
C++ programmers, the fact that it is legal means that the compiler
is of no help in enforcing it.
</p>

<p>So, if someone is doing a code review, and sees a function parameter declared
as a pointer to const, he must carefully review all the code in that function,
and all the code in functions called by that function that take the parameter
as an argument, to see if it is modified or not. This defeats much
of the purpose in declaring a parameter as const.
</p>

<p>But there are more problems with C++ const. Consider a class:
</p>

<pre class="cppcode">class C;
void foo(const C *p);
...
C c;
foo(&c);
</pre>

<p>Does <tt>foo()</tt> modify the contents of <tt>c</tt>?
Sure, through the <tt>const_cast</tt>, but
there's another legal way. class <tt>C</tt> could have mutable members:
</p>

<pre class="cppcode">class C
{
    public: mutable int x;
};

void foo(const C *p)
{
    p-&gt;x = 3;	// ok, C::x is mutable
}
</pre>

<p>So our beleagured code reviewer now has to search the definition of <tt>C</tt>
for
mutable members to see if <tt>foo()</tt> could modify <tt>c</tt>.
</p>

<p>The justification for mutable is the concept called <i>logical const</i>, where
an object appears to be const to an external viewer, but internally can
change. An example would be a class that maintains a cached internal result
of an expensive operation. The difficulty with this is two-fold. First,
there is no language support at all to ensure that mutable is not used for
something other than logical constness. It can be very difficult for a code
reviewer to determine if mutable is used correctly in this manner or not.
It is impossible to do automated detection of logical constness.
Mutable can be and is used for other purposes, and that is completely
legal and well-defined C++.
Second, having const references to mutable data renders unreliable the
ability to rely on const references not being modifiable, which has unfortunate
consequences for optimization and writing inherently threadsafe code.
It goes back to making it impossible to write generic code that must
not modify anything referenced by its parameters.
</p>

<p>There's one more problem. Suppose class <tt>C</tt> is the root of a collection,
which we'll trivially represent as <tt>T*</tt>:
</p>

<pre class="cppcode">class C
{
    T *q;
};
</pre>

<p>and a function <tt>foo()</tt> which reads the collection, and returns some
information about it:
</p>

<pre class="cppcode">int foo(const C *p);
</pre>

<p>The <tt>const</tt> only applies to the contents of class <tt>C</tt>, it does not
apply to
whatever <tt>q</tt> points to:
</p>

<pre class="cppcode">int foo(const C *p)
{
    *p-&gt;q = ...;	// ok, we can modify whatever C::q points to
    return 0;
}
</pre>

<p>There is no way to specify in <tt>foo()</tt>'s interface that it promises not to
modify
anything through its parameters. In other words, const is not transitive.
This is especially troublesome when attempting to write generic function
APIs based on unknown types:
</p>

<pre class="cppcode">template&lt;T&gt; int foo(const T *p) { ... }
</pre>

<p>Without knowing the instantiated type of <tt>T</tt>, it is impossible to know
if <tt>foo()</tt> is modifying things through its parameter or not.
</p>


<p>To summarize the difficulties with C++ const:
</p>

<ol><li>Const type attributes do not mean immutable data, they only mean
	a read-only view of the data. Other references to the same data
	can modify it at any time.
</li>

<li>It is legal and defined behavior to cast away const-ness and change
	the data anyway if the data was originally mutable.
</li>

<li>Mutable members override the constness of the declaration.
</li>

<li>Const is not transitive; there is no way to specify the constness
	of a complex type at the point of use of it.
</li>
</ol>


<p>C++ const is not a good match with the goals listed at the beginning of this
article. That means that it's worth a redesign.
</p>



<h2>Constness In D</h2>

<p>Clearly, there are two distinct meanings
to constant - meanings that are routinely conflated. One is that constant
data really is constant. It never changes. It's different enough that
it needs a different name. In D, this kind of constant is called an
invariant.
</p>

<p>Invariant data solves the aliasing problem, because even if there are
other aliases to the same data, since it is invariant, those references
cannot alter the data. The more invariant data a program uses, the
easier it is to understand. Invariants form a touchstone,
a reference point, for exploring the meaning of the rest of the code.
If the value of an invariant does change, it is a clear indication of
a severe program bug.
It's helpful to have this constraint statically enforced.
</p>

<p>The second kind of constant is a readonly view of data, even
though the data may be changed through another mutable reference to that
same data. This is called const, and is an invaluable modularity aid. One
function wants to look at some data; a module has the data, but wants to control
changes to it; all they need is a little protocol that allows the function to
look at the data, in confidence that it can't change it.
</p>

<p>Mutable references can be implicitly converted to const (as in C++).
Invariant references can also be implicitly converted to const.
But const cannot be implicitly converted to invariant, and neither can
mutable references.
Essentially, const is a weaker form of invariant because it says: "you can't
change this data; someone else may or may not be able to change it."
</p>

<p>Const references are usually used in function APIs, where the function
is guaranteeing it will not change any data reachable through that const
reference.
</p>

<p>Which brings up another aspect of const in D - it's transitive.
Const in C++ is not transitive, which means one can have a pointer
to const pointer to mutable int. To declare a variable that is const
at each level, one must write:
</p>

<pre class="cppcode">int const *const *const *p;   // C++
</pre>

<p>The <tt>const</tt> is left associative, so the declaration is a pointer to const
pointer to const pointer to const int. Const being transitive in D means
that every reference reachable through the const is also const.
An entire logical region of an application can be protected by placing only one
qualifier.
To reflect that, the syntax is different, using constructor-like notation:
</p>

<pre class="d_code2"><span class="d_keyword">const</span>(<span class="d_keyword">int</span> **)* p;	<span class="d_comment">// D
</span></pre>

<p>Here the <tt>const</tt> applies to the part of the type that is in parentheses.
Note that the syntax makes it impossible to declare things like
a pointer to a const pointer to a mutable type.
This slight loss in expressiveness is justifiable by the considerable power of
transitive protection.
</p>

<p>Transitive const solves the problem of specifying function interfaces
to data structs that truly are read only, even if they are generic functions
dealing with unknown types.
</p>

<p>Analogously to const, invariant types are transitive and follow the same
syntactical pattern as const.
</p>


<p>Because a static type system can be a straitjacket, there needs to be
a way to circumvent it for special cases. Like C++, D allows the casting away
of constness and invariantness. Unlike C++, if the programmer then
subverts the const or invariant guarantee and changes the underlying data,
then undefined behavior results.
</p>


<h2>References</h2>

<ul>	<li><a href="http://en.wikipedia.org/wiki/Const">Const-correctness</a> Wikipedia</li>
</ul>

<h2>Acknowledgments</h2>

<p>Many thanks for Andrei Alexandrescu, Bartosz Milewski, Brad Roberts,
David Held, Eric Niebler and many other members of the D community for their
major contributions to the design of the new const system.
</p>

<p>Many thanks in particular to Andrei Alexandrescu for reviewing this
article and making many invaluable suggestions for improving it.
</p>

<h2>Notes</h2>

<p><a name="note1">[1]</a> Several people have questioned this, arguing
that const_cast allows a const object to be legitimatedly changed.
The relevant standard paragraph is C++98 7.1.5.1-4:

<blockquote>
Except that any class member declared mutable (7.1.1) can be modified, any attempt to modify a const
object during its lifetime (3.8) results in undefined behavior.
</blockquote>
</p>


  
<br><br>
<br><br>
<!-- Google ad -->
<script type="text/javascript"><!--
/**/google_ad_client = "pub-5628673096434613";
/**/google_ad_width = 728;
/**/google_ad_height = 90;
/**/google_ad_format = "728x90_as";
/**/google_ad_channel ="3651639259";
/**/google_page_url = document.location;
//--></script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</div>




<div id="copyright">

Copyright &copy; 1999-2008 by Digital Mars, All Rights Reserved
 |
Page generated by <a href="http://www.digitalmars.com/d/2.0/ddoc.html">Ddoc</a>. |
<a href="http://www.prowiki.org/wiki4d/wiki.cgi?DocComments/Const" title="Read/write comments and feedback">Comments</a>
</div>

</body>
</html>

